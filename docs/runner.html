---

title: Title

keywords: fastai
sidebar: home_sidebar

summary: "summary"
description: "summary"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: Runner.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Runner">Runner<a class="anchor-link" href="#Runner"> </a></h1><p>This notebook shows how to perform a maxquant run.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">time</span> <span class="k">import</span> <span class="n">time</span>
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Logger">Logger<a class="anchor-link" href="#Logger"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="c1"># Create logger</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

<span class="c1"># Create STDERR handler</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
<span class="c1"># ch.setLevel(logging.DEBUG)</span>

<span class="c1"># Create formatter and add it to the handler</span>
<span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(levelname)-s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
<span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

<span class="c1"># Set STDERR handler as the only handler </span>
<span class="n">logger</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span><span class="n">handler</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sanity-Checks">Sanity Checks<a class="anchor-link" href="#Sanity-Checks"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>


<span class="k">def</span> <span class="nf">check_enviroment</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">numba</span> 
    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">numba</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mf">0.46</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Numba version </span><span class="si">{}</span><span class="s1"> not sufficient&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numba</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">check_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consistency check for settings.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">check_enviroment</span><span class="p">()</span>
    
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking raw path.&#39;</span><span class="p">)</span>

    <span class="c1">#Check if a valid raw file is provided. If a npz file is also provided do not convert</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;raw_path_npz&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;convert_raw&quot;</span><span class="p">]:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;convert_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NPZ for raw file present. Skipping conversion step.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;raw_path&quot;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No NPZ for raw present. Performing conversion step.&#39;</span><span class="p">)</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;convert_raw&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No raw or converted raw file provided&#39;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Raw path okay.&#39;</span><span class="p">)</span>

    <span class="c1">#Check library file</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Checking library path.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;fasta&quot;</span><span class="p">][</span><span class="s2">&quot;library_path&quot;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;create_library&quot;</span><span class="p">]:</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;create_library&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;NPZ for library file present. Skipping library creation step.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;fasta&quot;</span><span class="p">][</span><span class="s2">&quot;fasta_path&quot;</span><span class="p">]):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;No NPZ for library present. Creating library from FASTA.&#39;</span><span class="p">)</span>
            <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;create_library&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;No FASTA or library file provided&#39;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Library path okay.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">settings</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Callbacks">Callbacks<a class="anchor-link" href="#Callbacks"> </a></h2><p>For callback, we employ the following callback strategy:</p>
<ul>
<li><code>CURRENT_TASK</code></li>
<li><code>CURRENT_PROGRESS</code></li>
<li><code>OVERALL_PROGESS</code></li>
</ul>
<p>How can we estimate how long a task will take? Maybe we don't need this. Or later we can have some good estimates</p>
<p>General Tasks:</p>
<ul>
<li>File Conversion - 10%</li>
<li>Library Generation - 10%</li>
<li>Feature Finding - 40%</li>
<li>Search, Recalibration, Search - 30%</li>
<li>Output Tables - 10%</li>
</ul>
<p>At a later stage we should be able to add things</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">alphapept.settings</span> <span class="k">import</span> <span class="n">settings</span>

<span class="c1">#settings[&#39;raw&#39;][&#39;raw_path_npz&#39;] = &#39;F:/rawdata/04_hela_testrun/20190402_QX1_SeVW_MA_HeLa_500ng_LC11.npz&#39;</span>
<span class="n">settings</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="s1">&#39;raw_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;F:/rawdata/04_hela_testrun/20190402_QX1_SeVW_MA_HeLa_500ng_LC11.raw&#39;</span>
<span class="c1">#settings[&#39;fasta&#39;][&#39;library_path&#39;] = &#39;F:/rawdata/zz.database/uniprot_Human_reviewed_March_2019_manual.npz&#39;</span>
<span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fasta&#39;</span><span class="p">][</span><span class="s1">&#39;fasta_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;F:/rawdata/zz.database/uniprot_Human_reviewed_March_2019_manual.fasta&#39;</span>
<span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fasta&#39;</span><span class="p">][</span><span class="s1">&#39;contaminants_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;F:/projects/alphapept/contaminants.fasta&#39;</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">if</span> <span class="kc">True</span><span class="p">:</span> <span class="c1">#Uncomment to run</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

    <span class="n">CURRENT_TASK</span> <span class="o">=</span> <span class="nb">print</span>

    <span class="n">time_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;generate_library&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;generate_spectra&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;raw_to_npz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;raw_to_centroid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_hills&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;split_hills&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;filter_hills&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_hill_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_isotope_patterns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;feature_finder_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_psms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>



    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Current Progress&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">current_progress</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Overall Progress&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">overall_progress</span><span class="p">:</span>

            <span class="n">progress</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">def</span> <span class="nf">progress_wrapper</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                Wrapper function to change the overall progress with the current progress</span>
<span class="sd">                &quot;&quot;&quot;</span>

                <span class="k">global</span> <span class="n">progress</span>

                <span class="n">to_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">current</span><span class="o">*</span><span class="mi">100</span><span class="o">-</span><span class="n">current_progress</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">current_progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_update</span><span class="p">)</span>

                <span class="n">overall</span> <span class="o">=</span> <span class="n">progress</span> <span class="o">+</span> <span class="n">current</span><span class="o">*</span><span class="n">delta</span>
                <span class="n">to_update</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">overall</span><span class="o">-</span><span class="n">overall_progress</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

                <span class="n">overall_progress</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">to_update</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">current</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="n">progress</span> <span class="o">+=</span> <span class="n">delta</span>


            <span class="kn">from</span> <span class="nn">alphapept.constants</span> <span class="k">import</span> <span class="n">mass_dict</span>


            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Checking Settings&#39;</span><span class="p">)</span>
            <span class="n">settings</span> <span class="o">=</span> <span class="n">check_settings</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;create_library&quot;</span><span class="p">]:</span>
                <span class="kn">from</span> <span class="nn">alphapept.fasta</span> <span class="k">import</span> <span class="n">generate_library</span><span class="p">,</span> <span class="n">generate_spectra</span><span class="p">,</span> <span class="n">save_library</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Digesting FASTA&#39;</span><span class="p">)</span>
                <span class="n">to_add</span><span class="p">,</span> <span class="n">pept_dict</span><span class="p">,</span> <span class="n">fasta_dict</span> <span class="o">=</span> <span class="n">generate_library</span><span class="p">(</span><span class="n">mass_dict</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;generate_library&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fasta&#39;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Digested </span><span class="si">{:,}</span><span class="s1"> proteins and generated </span><span class="si">{:,}</span><span class="s1"> peptides&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fasta_dict</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_add</span><span class="p">)))</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Generating Spectra&#39;</span><span class="p">)</span>
                <span class="n">spectra</span> <span class="o">=</span> <span class="n">generate_spectra</span><span class="p">(</span><span class="n">to_add</span><span class="p">,</span> <span class="n">mass_dict</span><span class="p">,</span> <span class="n">callback</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;generate_spectra&#39;</span><span class="p">]))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Generated </span><span class="si">{:,}</span><span class="s1"> spectra&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spectra</span><span class="p">)))</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Saving library&#39;</span><span class="p">)</span>
                <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fasta&#39;</span><span class="p">][</span><span class="s1">&#39;fasta_path&#39;</span><span class="p">])</span>
                <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fasta&#39;</span><span class="p">][</span><span class="s1">&#39;library_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s1">&#39;.npz&#39;</span>
                <span class="n">library_path</span> <span class="o">=</span> <span class="n">save_library</span><span class="p">(</span><span class="n">spectra</span><span class="p">,</span> <span class="n">pept_dict</span><span class="p">,</span> <span class="n">fasta_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;fasta&#39;</span><span class="p">])</span>             
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Database saved to </span><span class="si">{}</span><span class="s1">. Filesize </span><span class="si">{:.2f}</span><span class="s1"> Gb&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">library_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">library_path</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span><span class="o">/</span><span class="p">(</span><span class="mi">1024</span><span class="o">**</span><span class="mi">3</span><span class="p">)))</span>


            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;general&quot;</span><span class="p">][</span><span class="s2">&quot;convert_raw&quot;</span><span class="p">]:</span>
                <span class="kn">from</span> <span class="nn">alphapept.io</span> <span class="k">import</span> <span class="n">raw_to_npz</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Converting raw files&#39;</span><span class="p">)</span>
                <span class="n">out_path</span> <span class="o">=</span> <span class="n">raw_to_npz</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">],</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;raw_to_npz&#39;</span><span class="p">]))</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;query_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Raw file(s) saved to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_path</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;query_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;raw_path_npz&quot;</span><span class="p">]</span>

            <span class="n">db_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;fasta&quot;</span><span class="p">][</span><span class="s2">&quot;library_path&quot;</span><span class="p">],</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">query_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;raw&quot;</span><span class="p">][</span><span class="s2">&quot;query_path&quot;</span><span class="p">],</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


            <span class="c1">#Feature Finding Part</span>

            <span class="kn">from</span> <span class="nn">alphapept.feature_finding</span> <span class="k">import</span> <span class="n">raw_to_centroid</span><span class="p">,</span> <span class="n">get_hills</span><span class="p">,</span> <span class="n">split_hills</span><span class="p">,</span> <span class="n">filter_hills</span><span class="p">,</span> <span class="n">get_hill_data</span><span class="p">,</span> <span class="n">get_edges</span><span class="p">,</span> <span class="n">get_isotope_patterns</span><span class="p">,</span> <span class="n">feature_finder_report</span>
            <span class="kn">from</span> <span class="nn">alphapept.constants</span> <span class="k">import</span> <span class="n">averagine_aa</span><span class="p">,</span> <span class="n">isotopes</span>


            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Converting centroids&#39;</span><span class="p">)</span>
            <span class="n">centroids</span> <span class="o">=</span> <span class="n">raw_to_centroid</span><span class="p">(</span><span class="n">query_data</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;raw_to_centroid&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loaded </span><span class="si">{:,}</span><span class="s1"> centroids.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">centroids</span><span class="p">)))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Exctracting hills&#39;</span><span class="p">)</span>
            <span class="n">completed_hills</span> <span class="o">=</span> <span class="n">get_hills</span><span class="p">(</span><span class="n">centroids</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_hills&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;A total of </span><span class="si">{:,}</span><span class="s1"> hills extracted. Average hill length </span><span class="si">{:.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">completed_hills</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">completed_hills</span><span class="p">])))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Splitting hills&#39;</span><span class="p">)</span>
            <span class="n">splitted_hills</span> <span class="o">=</span> <span class="n">split_hills</span><span class="p">(</span><span class="n">completed_hills</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;split_hills&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Split </span><span class="si">{:,}</span><span class="s1"> hills into </span><span class="si">{:,}</span><span class="s1"> hills&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">completed_hills</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">splitted_hills</span><span class="p">)))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Refining hills&#39;</span><span class="p">)</span>
            <span class="n">filtered_hills</span> <span class="o">=</span> <span class="n">filter_hills</span><span class="p">(</span><span class="n">splitted_hills</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;filter_hills&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Filtered </span><span class="si">{:,}</span><span class="s1"> hills. Remaining </span><span class="si">{:,}</span><span class="s1"> hills&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">splitted_hills</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_hills</span><span class="p">)))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Calculating hill statistics&#39;</span><span class="p">)</span>
            <span class="n">sorted_hills</span><span class="p">,</span> <span class="n">sorted_stats</span><span class="p">,</span> <span class="n">sorted_data</span> <span class="o">=</span> <span class="n">get_hill_data</span><span class="p">(</span><span class="n">filtered_hills</span><span class="p">,</span> <span class="n">centroids</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_hill_data&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracting hill stats complete&#39;</span><span class="p">)</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Connecting pre isotope patterns&#39;</span><span class="p">)</span>
            <span class="n">pre_isotope_patterns</span> <span class="o">=</span> <span class="n">get_edges</span><span class="p">(</span><span class="n">sorted_stats</span><span class="p">,</span> <span class="n">sorted_data</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_edges&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Found </span><span class="si">{}</span><span class="s1"> pre isotope patterns.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_isotope_patterns</span><span class="p">)))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Deisotope patterns&#39;</span><span class="p">)</span>
            <span class="n">isotope_patterns</span><span class="p">,</span> <span class="n">isotope_charges</span> <span class="o">=</span> <span class="n">get_isotope_patterns</span><span class="p">(</span><span class="n">pre_isotope_patterns</span><span class="p">,</span> <span class="n">sorted_stats</span><span class="p">,</span> <span class="n">sorted_data</span><span class="p">,</span> <span class="n">averagine_aa</span><span class="p">,</span> <span class="n">isotopes</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_isotope_patterns&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracted </span><span class="si">{}</span><span class="s1"> isotope patterns.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">isotope_patterns</span><span class="p">)))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Calculating feature statistics&#39;</span><span class="p">)</span>
            <span class="n">feature_table</span> <span class="o">=</span> <span class="n">feature_finder_report</span><span class="p">(</span><span class="n">isotope_patterns</span><span class="p">,</span> <span class="n">isotope_charges</span><span class="p">,</span> <span class="n">sorted_stats</span><span class="p">,</span> <span class="n">sorted_data</span><span class="p">,</span> <span class="n">sorted_hills</span><span class="p">,</span> <span class="n">query_data</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;feature_finder_report&#39;</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Report complete.&#39;</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">alphapept.matching</span> <span class="k">import</span> <span class="n">match_ms2</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">match_ms2</span><span class="p">(</span><span class="n">feature_table</span><span class="p">,</span> <span class="n">query_data</span><span class="p">)</span>


            <span class="c1"># Search part</span>

            <span class="kn">from</span> <span class="nn">alphapept.search</span> <span class="k">import</span> <span class="n">get_psms</span><span class="p">,</span> <span class="n">get_score_columns</span>
            <span class="kn">from</span> <span class="nn">alphapept.score</span> <span class="k">import</span> <span class="n">score_x_tandem</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Running first search.&#39;</span><span class="p">)</span>
            <span class="n">psms</span><span class="p">,</span> <span class="n">num_specs_compared</span> <span class="o">=</span> <span class="n">get_psms</span><span class="p">(</span><span class="n">query_data</span><span class="p">,</span> <span class="n">db_data</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_psms&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;First search complete. Compared </span><span class="si">{:,}</span><span class="s1"> spectra and found </span><span class="si">{:,}</span><span class="s1"> psms.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_specs_compared</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">psms</span><span class="p">)))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Extracting columns for scoring.&#39;</span><span class="p">)</span>
            <span class="n">psms</span><span class="p">,</span> <span class="n">num_specs_scored</span> <span class="o">=</span> <span class="n">get_score_columns</span><span class="p">(</span><span class="n">psms</span><span class="p">,</span> <span class="n">query_data</span><span class="p">,</span> <span class="n">db_data</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracted columns for </span><span class="si">{:,}</span><span class="s1"> psms.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_specs_scored</span><span class="p">))</span>


            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Scoring psms.&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">score_x_tandem</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">psms</span><span class="p">),</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">])</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scoring complete. For </span><span class="si">{}</span><span class="s1"> FDR found </span><span class="si">{:,}</span><span class="s1"> targets and </span><span class="si">{:,}</span><span class="s1"> decoys.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">][</span><span class="s2">&quot;peptide_fdr&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;decoy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="p">)</span>


            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">][</span><span class="s1">&#39;calibrate&#39;</span><span class="p">]:</span>

                <span class="kn">from</span> <span class="nn">alphapept.recalibration</span> <span class="k">import</span> <span class="n">get_calibration</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Calibrating features.&#39;</span><span class="p">)</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Precursor Offset (PPM) is </span><span class="si">{:.2f}</span><span class="s1"> (mean), </span><span class="si">{:.2f}</span><span class="s1"> (std)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;o_mass_ppm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;o_mass_ppm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()))</span>
                <span class="s1">&#39;Calibrating MS1 spectra&#39;</span>
                <span class="n">features_calib</span><span class="p">,</span> <span class="n">df_sub</span> <span class="o">=</span> <span class="n">get_calibration</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;calibration&quot;</span><span class="p">])</span>

                <span class="n">o_mass_ppm_mean</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;o_mass_ppm_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">o_mass_ppm_std</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;o_mass_ppm_calib&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Calibration complete. Precursor Offset (PPM) is </span><span class="si">{:.2f}</span><span class="s1"> (mean), </span><span class="si">{:.2f}</span><span class="s1"> (std)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">o_mass_ppm_mean</span><span class="p">,</span> <span class="n">o_mass_ppm_std</span><span class="p">))</span>

                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Adjusting search bound to </span><span class="si">{:.2f}</span><span class="s1"> ppm.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">o_mass_ppm_std</span><span class="p">))</span>

                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">][</span><span class="s2">&quot;m_offset_calibrated&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">o_mass_ppm_std</span><span class="p">)</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Running second search.&#39;</span><span class="p">)</span>
                <span class="n">psms</span><span class="p">,</span> <span class="n">num_specs_compared</span> <span class="o">=</span> <span class="n">get_psms</span><span class="p">(</span><span class="n">query_data</span><span class="p">,</span> <span class="n">db_data</span><span class="p">,</span> <span class="n">features_calib</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_wrapper</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="n">time_dict</span><span class="p">[</span><span class="s1">&#39;get_psms&#39;</span><span class="p">]),</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Second search complete. Compared </span><span class="si">{:,}</span><span class="s1"> spectra and found </span><span class="si">{:,}</span><span class="s1"> psms.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_specs_compared</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">psms</span><span class="p">)))</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Extracting columns for scoring.&#39;</span><span class="p">)</span>
                <span class="n">psms</span><span class="p">,</span> <span class="n">num_specs_scored</span> <span class="o">=</span> <span class="n">get_score_columns</span><span class="p">(</span><span class="n">psms</span><span class="p">,</span> <span class="n">query_data</span><span class="p">,</span> <span class="n">db_data</span><span class="p">,</span> <span class="n">features_calib</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Extracted columns for </span><span class="si">{:,}</span><span class="s1"> psms.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_specs_scored</span><span class="p">))</span>

                <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Scoring psms.&#39;</span><span class="p">)</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">score_x_tandem</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">psms</span><span class="p">),</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">])</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scoring complete. For </span><span class="si">{}</span><span class="s1"> FDR found </span><span class="si">{:,}</span><span class="s1"> targets and </span><span class="si">{:,}</span><span class="s1"> decoys.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">][</span><span class="s2">&quot;peptide_fdr&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;decoy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="p">)</span>

            <span class="c1">## Protein Groups and FDR control</span>

            <span class="kn">from</span> <span class="nn">alphapept.score</span> <span class="k">import</span> <span class="n">cut_global_fdr</span><span class="p">,</span> <span class="n">perform_protein_grouping</span><span class="p">,</span> <span class="n">cut_global_fdr</span><span class="p">,</span> <span class="n">get_x_tandem_score</span><span class="p">,</span> <span class="n">filter_score</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Scoring&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">psms</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_x_tandem_score</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;decoy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">islower</span><span class="p">()</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">filter_score</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;FDR control on peptides&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">cut_global_fdr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">analyte_level</span><span class="o">=</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span>  <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scoring peptides complete. For </span><span class="si">{}</span><span class="s1"> FDR found </span><span class="si">{:,}</span><span class="s1"> targets and </span><span class="si">{:,}</span><span class="s1"> decoys.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">][</span><span class="s2">&quot;peptide_fdr&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;decoy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="p">)</span>


            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Perform protein grouping&#39;</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">perform_protein_grouping</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">db_data</span><span class="p">[</span><span class="s1">&#39;pept_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">db_data</span><span class="p">[</span><span class="s1">&#39;fasta_dict&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">cut_global_fdr</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">analyte_level</span><span class="o">=</span><span class="s1">&#39;protein&#39;</span><span class="p">,</span>  <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Scoring proteins complete. For </span><span class="si">{}</span><span class="s1"> FDR found </span><span class="si">{:,}</span><span class="s1"> targets and </span><span class="si">{:,}</span><span class="s1"> decoys. A total of </span><span class="si">{:,}</span><span class="s1"> proteins found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;search&quot;</span><span class="p">][</span><span class="s2">&quot;protein_fdr&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;decoy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;protein&#39;</span><span class="p">]))))</span>

            <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;Saving&#39;</span><span class="p">)</span>

            <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="s1">&#39;query_path&#39;</span><span class="p">])</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s1">&#39;_ap.csv&#39;</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Saved to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_path</span><span class="p">))</span>
            
            <span class="kn">import</span> <span class="nn">yaml</span>
            
            <span class="n">out_path_settings</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="s1">&#39;_ap.yaml&#39;</span>
            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path_settings</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Settings saved to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_path_settings</span><span class="p">))</span>

    <span class="n">CURRENT_TASK</span><span class="p">(</span><span class="s1">&#39;COMPLETE&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>&lt;ipython-input-5-627cbef762cd&gt;:26: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0
Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`
  with tqdm(total=100, desc=&#39;Current Progress&#39;, unit=&#39;%&#39;) as current_progress:
&lt;ipython-input-5-627cbef762cd&gt;:27: TqdmDeprecationWarning: This function will be removed in tqdm==5.0.0
Please use `tqdm.notebook.tqdm` instead of `tqdm.tqdm_notebook`
  with tqdm(total=100, desc=&#39;Overall Progress&#39;, unit=&#39;%&#39;) as overall_progress:
2020-04-25 17:54:31 INFO - Checking raw path.
2020-04-25 17:54:31 INFO - No NPZ for raw present. Performing conversion step.
2020-04-25 17:54:31 INFO - Raw path okay.
2020-04-25 17:54:31 INFO - Checking library path.
2020-04-25 17:54:31 INFO - No NPZ for library present. Creating library from FASTA.
2020-04-25 17:54:31 INFO - Library path okay.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Checking Settings
Digesting FASTA
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 17:56:00 INFO - Digested 20,664 proteins and generated 5,289,587 peptides
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Generating Spectra
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 17:58:19 INFO - Generated 5,289,587 spectra
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Saving library
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 17:58:56 INFO - Database saved to F:/rawdata/zz.database/uniprot_Human_reviewed_March_2019_manual.npz. Filesize 3.28 Gb
2020-04-25 17:58:56 INFO - Imported existing &lt;module &#39;comtypes.gen&#39; from &#39;C:\\ProgramData\\Anaconda3\\envs\\alphap\\lib\\site-packages\\comtypes\\gen\\__init__.py&#39;&gt;
2020-04-25 17:58:56 INFO - Using writeable comtypes cache directory: &#39;C:\ProgramData\Anaconda3\envs\alphap\lib\site-packages\comtypes\gen&#39;
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converting raw files
Raw File saved to F:/rawdata/04_hela_testrun/20190402_QX1_SeVW_MA_HeLa_500ng_LC11.npz
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:00:41 INFO - Raw file(s) saved to [&#39;F:/rawdata/04_hela_testrun/20190402_QX1_SeVW_MA_HeLa_500ng_LC11.npz&#39;]
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converting centroids
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:00:59 INFO - Loaded 13,230 centroids.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Exctracting hills
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>C:\ProgramData\Anaconda3\envs\alphap\lib\site-packages\numba\ir_utils.py:2041: NumbaPendingDeprecationWarning: <span class="ansi-bold">
Encountered the use of a type that is scheduled for deprecation: type &#39;reflected list&#39; found for argument &#39;centroids&#39; of function &#39;connect_centroids_forward&#39;.

For more information visit http://numba.pydata.org/numba-doc/latest/reference/deprecation.html#deprecation-of-reflection-for-list-and-set-types
</span><span class="ansi-bold">
File &#34;alphapept\feature_finding.py&#34;, line 189:</span>
<span class="ansi-bold">@njit
</span><span class="ansi-bold">def connect_centroids_forward(centroids, max_centroids, max_gap, ppm_tol):
</span><span class="ansi-bold">^</span>

  warnings.warn(NumbaPendingDeprecationWarning(msg, loc=loc))
C:\ProgramData\Anaconda3\envs\alphap\lib\site-packages\numba\ir_utils.py:2041: NumbaPendingDeprecationWarning: <span class="ansi-bold">
Encountered the use of a type that is scheduled for deprecation: type &#39;reflected list&#39; found for argument &#39;centroids&#39; of function &#39;connect_centroids_backward&#39;.

For more information visit http://numba.pydata.org/numba-doc/latest/reference/deprecation.html#deprecation-of-reflection-for-list-and-set-types
</span><span class="ansi-bold">
File &#34;alphapept\feature_finding.py&#34;, line 232:</span>
<span class="ansi-bold">@njit
</span><span class="ansi-bold">def connect_centroids_backward(centroids, max_centroids, max_gap, ppm_tol):
</span><span class="ansi-bold">^</span>

  warnings.warn(NumbaPendingDeprecationWarning(msg, loc=loc))
2020-04-25 18:06:16 INFO - A total of 992,051 hills extracted. Average hill length 16.04
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Splitting hills
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:07:50 INFO - Split 992,051 hills into 1,239,960 hills
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Refining hills
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:08:19 INFO - Filtered 1,239,960 hills. Remaining 1,221,467 hills
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Calculating hill statistics
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>C:\ProgramData\Anaconda3\envs\alphap\lib\site-packages\numba\ir_utils.py:2041: NumbaPendingDeprecationWarning: <span class="ansi-bold">
Encountered the use of a type that is scheduled for deprecation: type &#39;reflected list&#39; found for argument &#39;hill_data&#39; of function &#39;get_hill_data_numba&#39;.

For more information visit http://numba.pydata.org/numba-doc/latest/reference/deprecation.html#deprecation-of-reflection-for-list-and-set-types
</span><span class="ansi-bold">
File &#34;alphapept\feature_finding.py&#34;, line 581:</span>
<span class="ansi-bold">@njit
</span><span class="ansi-bold">def get_hill_data_numba(hill_data):
</span><span class="ansi-bold">^</span>

  warnings.warn(NumbaPendingDeprecationWarning(msg, loc=loc))
2020-04-25 18:12:12 INFO - Extracting hill stats complete
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Connecting pre isotope patterns
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:13:43 INFO - Found 200024 pre isotope patterns.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Deisotope patterns
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:15:50 INFO - Extracted 218772 isotope patterns.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Calculating feature statistics
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:16:35 INFO - Report complete.
F:\projects\alphapept\alphapept\matching.py:23: RuntimeWarning: divide by zero encountered in log
  query_mz = np.log(query_data[&#39;mono_mzs2&#39;])*1e6/ppm_range
2020-04-25 18:16:36 INFO - Note: NumExpr detected 24 cores but &#34;NUMEXPR_MAX_THREADS&#34; not set, so enforcing safe limit of 8.
2020-04-25 18:16:36 INFO - NumExpr defaulting to 8 threads.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Running first search.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:17:11 INFO - First search complete. Compared 52,202,484 spectra and found 225,611 psms.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Extracting columns for scoring.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:17:50 INFO - Extracted columns for 225,611 psms.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring psms.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:17:51 INFO - Scoring complete. For 0.01 FDR found 56,709 targets and 567 decoys.
2020-04-25 18:17:51 INFO - Precursor Offset (PPM) is -3.81 (mean), 5.11 (std)
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Calibrating features.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>F:\projects\alphapept\alphapept\recalibration.py:74: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_sub[&#39;o_mass_ppm_offset&#39;] = f2
F:\projects\alphapept\alphapept\recalibration.py:75: SettingWithCopyWarning: 
A value is trying to be set on a copy of a slice from a DataFrame.
Try using .loc[row_indexer,col_indexer] = value instead

See the caveats in the documentation: https://pandas.pydata.org/pandas-docs/stable/user_guide/indexing.html#returning-a-view-versus-a-copy
  df_sub[&#39;o_mass_ppm_calib&#39;] = (df_sub[&#39;o_mass_ppm&#39;]-df_sub[&#39;o_mass_ppm_offset&#39;])
2020-04-25 18:18:24 INFO - Calibration complete. Precursor Offset (PPM) is 0.01 (mean), 1.74 (std)
2020-04-25 18:18:24 INFO - Adjusting search bound to 5.23 ppm.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Running second search.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:18:36 INFO - Second search complete. Compared 14,563,577 spectra and found 116,938 psms.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Extracting columns for scoring.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:18:55 INFO - Extracted columns for 116,938 psms.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring psms.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:18:56 INFO - Scoring complete. For 0.01 FDR found 53,925 targets and 539 decoys.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Scoring
FDR control on peptides
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:18:57 INFO - Scoring peptides complete. For 0.01 FDR found 53,310 targets and 447 decoys.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Perform protein grouping
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:20:15 INFO - Scoring proteins complete. For 0.01 FDR found 51,485 targets and 71 decoys. A total of 5,862 proteins found.
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Saving
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2020-04-25 18:20:16 INFO - Saved to F:/rawdata/04_hela_testrun/20190402_QX1_SeVW_MA_HeLa_500ng_LC11_ap.csv
2020-04-25 18:20:16 INFO - Settings saved to F:/rawdata/04_hela_testrun/20190402_QX1_SeVW_MA_HeLa_500ng_LC11_ap.yaml
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>

COMPLETE
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

