<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.189">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Functions related to the search">

<title>alphapept - Search</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="alphapept - Search">
<meta property="og:description" content="Functions related to the search">
<meta property="og:site-name" content="alphapept">
<meta name="twitter:title" content="alphapept - Search">
<meta name="twitter:description" content="Functions related to the search">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">alphapept</span>
    </a>
  </div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Search</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">AlphaPept</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./settings.html" class="sidebar-item-text sidebar-link">Settings</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./chem.html" class="sidebar-item-text sidebar-link">Chem</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./io.html" class="sidebar-item-text sidebar-link">Input / Output</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fasta.html" class="sidebar-item-text sidebar-link">FASTA</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./feature_finding.html" class="sidebar-item-text sidebar-link">Feature Finding</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./search.html" class="sidebar-item-text sidebar-link active">Search</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./score.html" class="sidebar-item-text sidebar-link">Score</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./recalibration.html" class="sidebar-item-text sidebar-link">Recalibration</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./quantification.html" class="sidebar-item-text sidebar-link">Quantification</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./matching.html" class="sidebar-item-text sidebar-link">Matching</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./constants.html" class="sidebar-item-text sidebar-link">Constants</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./interface.html" class="sidebar-item-text sidebar-link">Interface</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./performance.html" class="sidebar-item-text sidebar-link">Performance</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./export.html" class="sidebar-item-text sidebar-link">Export</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./display.html" class="sidebar-item-text sidebar-link">Display</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./label.html" class="sidebar-item-text sidebar-link">Label</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./additional_code.html" class="sidebar-item-text sidebar-link">Additional code</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./contributing.html" class="sidebar-item-text sidebar-link">How to contribute</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./file_formats.html" class="sidebar-item-text sidebar-link">AlphaPept workflow and files</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#comparing-spectra" id="toc-comparing-spectra" class="nav-link active" data-scroll-target="#comparing-spectra">Comparing spectra</a>
  <ul class="collapse">
  <li><a href="#compare_frags" id="toc-compare_frags" class="nav-link" data-scroll-target="#compare_frags">compare_frags</a></li>
  </ul></li>
  <li><a href="#comparing-spectra-1" id="toc-comparing-spectra-1" class="nav-link" data-scroll-target="#comparing-spectra-1">Comparing Spectra</a>
  <ul class="collapse">
  <li><a href="#ppm_to_dalton" id="toc-ppm_to_dalton" class="nav-link" data-scroll-target="#ppm_to_dalton">ppm_to_dalton</a></li>
  <li><a href="#get_idxs" id="toc-get_idxs" class="nav-link" data-scroll-target="#get_idxs">get_idxs</a></li>
  <li><a href="#compare_spectrum_parallel" id="toc-compare_spectrum_parallel" class="nav-link" data-scroll-target="#compare_spectrum_parallel">compare_spectrum_parallel</a></li>
  </ul></li>
  <li><a href="#wrapper" id="toc-wrapper" class="nav-link" data-scroll-target="#wrapper">Wrapper</a>
  <ul class="collapse">
  <li><a href="#query_data_to_features" id="toc-query_data_to_features" class="nav-link" data-scroll-target="#query_data_to_features">query_data_to_features</a></li>
  <li><a href="#get_psms" id="toc-get_psms" class="nav-link" data-scroll-target="#get_psms">get_psms</a></li>
  </ul></li>
  <li><a href="#extracting-columns-for-scoring" id="toc-extracting-columns-for-scoring" class="nav-link" data-scroll-target="#extracting-columns-for-scoring">Extracting columns for scoring</a>
  <ul class="collapse">
  <li><a href="#frag-delta" id="toc-frag-delta" class="nav-link" data-scroll-target="#frag-delta">Frag Delta</a></li>
  <li><a href="#frag_delta" id="toc-frag_delta" class="nav-link" data-scroll-target="#frag_delta">frag_delta</a></li>
  <li><a href="#intensity-fraction" id="toc-intensity-fraction" class="nav-link" data-scroll-target="#intensity-fraction">Intensity Fraction</a></li>
  <li><a href="#intensity_fraction" id="toc-intensity_fraction" class="nav-link" data-scroll-target="#intensity_fraction">intensity_fraction</a></li>
  <li><a href="#file-format" id="toc-file-format" class="nav-link" data-scroll-target="#file-format">File Format</a></li>
  <li><a href="#remove_column" id="toc-remove_column" class="nav-link" data-scroll-target="#remove_column">remove_column</a></li>
  <li><a href="#add_column" id="toc-add_column" class="nav-link" data-scroll-target="#add_column">add_column</a></li>
  </ul></li>
  <li><a href="#extracting-features-for-scoring" id="toc-extracting-features-for-scoring" class="nav-link" data-scroll-target="#extracting-features-for-scoring">Extracting features for scoring</a>
  <ul class="collapse">
  <li><a href="#indices" id="toc-indices" class="nav-link" data-scroll-target="#indices">Indices</a></li>
  <li><a href="#features" id="toc-features" class="nav-link" data-scroll-target="#features">Features</a></li>
  <li><a href="#get_hits" id="toc-get_hits" class="nav-link" data-scroll-target="#get_hits">get_hits</a></li>
  <li><a href="#score" id="toc-score" class="nav-link" data-scroll-target="#score">score</a></li>
  <li><a href="#get_sequences" id="toc-get_sequences" class="nav-link" data-scroll-target="#get_sequences">get_sequences</a></li>
  <li><a href="#get_score_columns" id="toc-get_score_columns" class="nav-link" data-scroll-target="#get_score_columns">get_score_columns</a></li>
  </ul></li>
  <li><a href="#plot" id="toc-plot" class="nav-link" data-scroll-target="#plot">Plot</a>
  <ul class="collapse">
  <li><a href="#plot_psms" id="toc-plot_psms" class="nav-link" data-scroll-target="#plot_psms">plot_psms</a></li>
  </ul></li>
  <li><a href="#searching-with-database" id="toc-searching-with-database" class="nav-link" data-scroll-target="#searching-with-database">Searching with database</a>
  <ul class="collapse">
  <li><a href="#search_db" id="toc-search_db" class="nav-link" data-scroll-target="#search_db">search_db</a></li>
  <li><a href="#store_hdf" id="toc-store_hdf" class="nav-link" data-scroll-target="#store_hdf">store_hdf</a></li>
  </ul></li>
  <li><a href="#searching-large-fasta-and-or-search-space" id="toc-searching-large-fasta-and-or-search-space" class="nav-link" data-scroll-target="#searching-large-fasta-and-or-search-space">Searching Large Fasta and or Search Space</a>
  <ul class="collapse">
  <li><a href="#search_fasta_block" id="toc-search_fasta_block" class="nav-link" data-scroll-target="#search_fasta_block">search_fasta_block</a></li>
  <li><a href="#filter_top_n" id="toc-filter_top_n" class="nav-link" data-scroll-target="#filter_top_n">filter_top_n</a></li>
  <li><a href="#search_parallel" id="toc-search_parallel" class="nav-link" data-scroll-target="#search_parallel">search_parallel</a></li>
  <li><a href="#ion_extractor" id="toc-ion_extractor" class="nav-link" data-scroll-target="#ion_extractor">ion_extractor</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/mannlabs/alphapept/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Search</h1>
</div>

<div>
  <div class="description">
    Functions related to the search
  </div>
</div>


<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This notebook contains all functions related to searching and getting peptide-spectrum-matches (PSMs). When searching, we compare how similar an experimental spectrum is to a theoretical spectrum. As described in the FASTA notebook, we can calculate theoretical fragment masses for a given peptide sequence and get theoretical spectra. Typically, we calculate a database with all possible spectra, save it to disk, and then compare our experimental data. This allows re-using the database and saving time for this computational step. It could be that the database is too large to be saved on disc; in this case, generate the database on the fly, referring to only have a subset of all FASTA entries in memory and processing them.</p>
<section id="comparing-spectra" class="level2">
<h2 class="anchored" data-anchor-id="comparing-spectra">Comparing spectra</h2>
<p>To efficiently compare two spectra, we use a pointer based approach. We start with two sorted arrays, the <code>query_frag</code> that contains the m/z positions of the experimental query spectrum and the <code>db_frag</code> which contains the database fragment that is compared against to. The two pointers compare each m/z position with each other and check wheter they are within a certain tolerance <code>frag_tol</code>. Depending on their delta, either of the pointers is advanced. The function returns an arrray named <code>hits</code> that is the same length as the database spectrum and encodes the hit positions.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L15" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="compare_frags" class="level3">
<h3 class="anchored" data-anchor-id="compare_frags">compare_frags</h3>
<blockquote class="blockquote">
<pre><code> compare_frags (query_frag:numpy.ndarray, db_frag:numpy.ndarray,
                frag_tol:float, ppm:bool=False)</code></pre>
</blockquote>
<p>Compare query and database frags and find hits</p>
<p>Args: query_frag (np.ndarray): Array with query fragments. db_frag (np.ndarray): Array with database fragments. frag_tol (float): Fragment tolerance for search. ppm (bool, optional): Use ppm as unit or Dalton. Defaults to False.</p>
<p>Returns: np.ndarray: Array with reported hits.</p>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>query_frag <span class="op">=</span> np.array([<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">400</span>])</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>db_frag <span class="op">=</span> np.array([<span class="dv">150</span>, <span class="dv">200</span>, <span class="dv">300</span>, <span class="dv">450</span>])</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Hits: Query 2 -&gt; Db 2 and Query 3 -&gt; Db 3</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>compare_frags(query_frag, db_frag, frag_tol<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<pre><code>array([0, 2, 3, 0], dtype=int16)</code></pre>
</div>
</div>
<p>This function allows us to easily compare a query spectrum against a spectrum from a theoretical database.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> alphapept <span class="im">import</span> constants</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> alphapept.fasta <span class="im">import</span> get_frag_dict, parse</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> alphapept.io</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>peptide <span class="op">=</span> <span class="st">'PEPTIDE'</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Theoretical Spectrum</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>frag_dict <span class="op">=</span> get_frag_dict(parse(peptide), constants.mass_dict)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>db_frag <span class="op">=</span> <span class="bu">list</span>(frag_dict.values())</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>db_frag.sort()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>db_int <span class="op">=</span> [<span class="dv">100</span> <span class="cf">for</span> _ <span class="kw">in</span> db_frag]</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Experimental Spectrum, dummy data</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>query_frag <span class="op">=</span> np.array([<span class="fl">98.06</span>, <span class="fl">227.10</span>, <span class="fl">263.08</span>, <span class="fl">548.06</span>, <span class="fl">653.31</span>])</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>query_int <span class="op">=</span> np.array([<span class="dv">20</span>, <span class="dv">80</span>, <span class="dv">30</span>, <span class="dv">30</span>, <span class="dv">50</span>])</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>hits <span class="op">=</span> compare_frags(query_frag, db_frag, frag_tol<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>hitpos <span class="op">=</span> hits[hits <span class="op">&gt;</span> <span class="dv">0</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>hit_x <span class="op">=</span> query_frag[hitpos]</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>hit_y <span class="op">=</span> query_int[hitpos]</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">5</span>))</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>plt.vlines(db_frag, <span class="dv">0</span>, db_int, <span class="st">"k"</span>, label<span class="op">=</span><span class="st">"DB"</span>, alpha<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>plt.vlines(query_frag, <span class="dv">0</span>, query_int, <span class="st">"r"</span>, label<span class="op">=</span><span class="st">"Query"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>plt.plot(hit_x, hit_y, <span class="st">"ro"</span>, label<span class="op">=</span><span class="st">"Hit"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> frag_dict.keys():</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    plt.text(frag_dict[_], <span class="dv">104</span>, _, fontsize<span class="op">=</span><span class="dv">12</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>)</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Theoretical Spectrum for </span><span class="sc">{}</span><span class="st">'</span>.<span class="bu">format</span>(peptide))</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Mass'</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Intensity'</span>)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="dv">0</span>,<span class="dv">110</span>])</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="05_search_files/figure-html/cell-4-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="comparing-spectra-1" class="level2">
<h2 class="anchored" data-anchor-id="comparing-spectra-1">Comparing Spectra</h2>
<p>To compare multiple spectra against a database, we first need some helper functions. First, we need a conversion function to convert from Dalton masses to ppm, which is implemented in the <a href="https://mannlabs.github.io/alphapept/search.html#ppm_to_dalton"><code>ppm_to_dalton</code></a> function.</p>
<p>To minimize the search space, we typically only compare spectra with precursors in the same mass range as defined by <code>prec_tol</code>. To look up the limits for search, we define the function <a href="https://mannlabs.github.io/alphapept/search.html#get_idxs"><code>get_idxs</code></a>, which is a wrapper to the fast <code>searchsorted</code> method from <code>NumPy</code>.</p>
<p>The actual search takes place in <a href="https://mannlabs.github.io/alphapept/search.html#compare_spectrum_parallel"><code>compare_spectrum_parallel</code></a>, which utilizes the performance decorator from the performance notebook. Here we save the top matching spectra for each query spectrum. Note that for code compilation reasons, the code of the previously defined function <a href="https://mannlabs.github.io/alphapept/search.html#compare_frags"><code>compare_frags</code></a> is duplicated in here.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L55" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="ppm_to_dalton" class="level3">
<h3 class="anchored" data-anchor-id="ppm_to_dalton">ppm_to_dalton</h3>
<blockquote class="blockquote">
<pre><code> ppm_to_dalton (mass:float, prec_tol:int)</code></pre>
</blockquote>
<p>Function to convert ppm tolerances to Dalton.</p>
<p>Args: mass (float): Base mass. prec_tol (int): Tolerance.</p>
<p>Returns: float: Tolerance in Dalton.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L68" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_idxs" class="level3">
<h3 class="anchored" data-anchor-id="get_idxs">get_idxs</h3>
<blockquote class="blockquote">
<pre><code> get_idxs (db_masses:numpy.ndarray, query_masses:numpy.ndarray,
           prec_tol:float, ppm:bool)</code></pre>
</blockquote>
<p>Function to get upper and lower limits to define search range for a given precursor tolerance.</p>
<p>Args: db_masses (np.ndarray): Array containing database masses. query_masses (np.ndarray): Array containing query masses. prec_tol (float): Precursor tolerance for search. ppm: Flag to use ppm instead of Dalton.</p>
<p>Returns: (np.ndarray, np.ndarray): Indices to lower and upper bounds.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L95" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="compare_spectrum_parallel" class="level3">
<h3 class="anchored" data-anchor-id="compare_spectrum_parallel">compare_spectrum_parallel</h3>
<blockquote class="blockquote">
<pre><code> compare_spectrum_parallel (query_idx:int, query_masses:numpy.ndarray,
                            idxs_lower:numpy.ndarray,
                            idxs_higher:numpy.ndarray,
                            query_indices:numpy.ndarray,
                            query_frags:numpy.ndarray,
                            query_ints:numpy.ndarray,
                            db_indices:numpy.ndarray,
                            db_frags:numpy.ndarray,
                            best_hits:numpy.ndarray, score:numpy.ndarray,
                            frag_tol:float, ppm:bool)</code></pre>
</blockquote>
<p>Compares a spectrum and writes to the best_hits and score.</p>
<p>Args: query_idx (int): Integer to the query_spectrum that should be compared. query_masses (np.ndarray): Array with query masses. idxs_lower (np.ndarray): Array with indices for lower search boundary. idxs_higher (np.ndarray): Array with indices for upper search boundary. query_indices (np.ndarray): Array with indices to the query data. query_frags (np.ndarray): Array with frag types of the query data. query_ints (np.ndarray): Array with fragment intensities from the query. db_indices (np.ndarray): Array with indices to the database data. db_frags (np.ndarray): Array with frag types of the db data. best_hits (np.ndarray): Reporting array which stores indices to the best hits. score (np.ndarray): Reporting array that stores the scores of the best hits. frag_tol (float): Fragment tolerance for search. ppm (bool): Flag to use ppm instead of Dalton.</p>
</section>
</section>
<section id="wrapper" class="level2">
<h2 class="anchored" data-anchor-id="wrapper">Wrapper</h2>
<p>To conveniently perform peptide-spectrum matches on multiple datasets we define a wrapper <a href="https://mannlabs.github.io/alphapept/search.html#get_psms"><code>get_psms</code></a> that returns the PSMS when handing over <code>query_data</code> and <code>db_data</code>.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L191" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="query_data_to_features" class="level3">
<h3 class="anchored" data-anchor-id="query_data_to_features">query_data_to_features</h3>
<blockquote class="blockquote">
<pre><code> query_data_to_features (query_data:dict)</code></pre>
</blockquote>
<p>Helper function to extract features from query data. This is used when the feature finder will not be used.</p>
<p>Args: query_data (dict): Data structure containing the query data.</p>
<p>Returns: pd.DataFrame: Pandas dataframe so that it can be used for subsequent processing.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L218" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_psms" class="level3">
<h3 class="anchored" data-anchor-id="get_psms">get_psms</h3>
<blockquote class="blockquote">
<pre><code> get_psms (query_data:dict, db_data:dict,
           features:pandas.core.frame.DataFrame, parallel:bool,
           frag_tol:float, prec_tol:float, ppm:bool, min_frag_hits:int,
           callback:Callable=None, prec_tol_calibrated:float=None,
           frag_tol_calibrated:float=None, **kwargs)</code></pre>
</blockquote>
<p>[summary]</p>
<p>Args: query_data (dict): Data structure containing the query data. db_data (dict): Data structure containing the database data. features (pd.DataFrame): Pandas dataframe containing feature data. parallel (bool): Flag to use parallel processing. frag_tol (float): Fragment tolerance for search. prec_tol (float): Precursor tolerance for search. ppm (bool): Flag to use ppm instead of Dalton. min_frag_hits (int): Minimum number of frag hits to report a PSMs. callback (Callable, optional): Optional callback. Defaults to None. prec_tol_calibrated (float, optional): Precursor tolerance if calibration exists. Defaults to None. frag_tol_calibrated (float, optional): Fragment tolerance if calibration exists. Defaults to None.</p>
<p>Returns: np.ndarray: Numpy recordarray storing the PSMs. int: 0</p>
</section>
</section>
<section id="extracting-columns-for-scoring" class="level2">
<h2 class="anchored" data-anchor-id="extracting-columns-for-scoring">Extracting columns for scoring</h2>
<p>The basic fragment comparison only counts the number of hits and matched intensity fraction when comparing a theoretical spectrum to an experimental one. Based on this metric, we can drastically reduce the number of candidates one wants to analyze for an in-depth comparison, which requires additional features. The following section describes several functions which extract parameters to compare spectrum matches better.</p>
<section id="frag-delta" class="level3">
<h3 class="anchored" data-anchor-id="frag-delta">Frag Delta</h3>
<p><a href="https://mannlabs.github.io/alphapept/search.html#frag_delta"><code>frag_delta</code></a> substracts the experimental fragment masses from the theoretical fragment masses for each hit.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L358" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="frag_delta" class="level3">
<h3 class="anchored" data-anchor-id="frag_delta">frag_delta</h3>
<blockquote class="blockquote">
<pre><code> frag_delta (query_frag:numpy.ndarray, db_frag:numpy.ndarray,
             hits:numpy.ndarray)</code></pre>
</blockquote>
<p>Calculates the mass difference for a given array of hits in Dalton and ppm.</p>
<p>Args: query_frag (np.ndarray): Array with query fragments. db_frag (np.ndarray): Array with database fragments. hits (np.ndarray): Array with reported hits.</p>
<p>Returns: float: Fragment deltas in Dalton. float: Fragment deltas in ppm.</p>
</section>
<section id="intensity-fraction" class="level3">
<h3 class="anchored" data-anchor-id="intensity-fraction">Intensity Fraction</h3>
<p><a href="https://mannlabs.github.io/alphapept/search.html#intensity_fraction"><code>intensity_fraction</code></a> calculates the fraction of matched intensity. This refers to the intensity of all hits compared to the intensity of all peaks in the query spectrum.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L379" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="intensity_fraction" class="level3">
<h3 class="anchored" data-anchor-id="intensity_fraction">intensity_fraction</h3>
<blockquote class="blockquote">
<pre><code> intensity_fraction (query_int:numpy.ndarray, hits:numpy.ndarray)</code></pre>
</blockquote>
<p>Calculate the fraction of matched intensity</p>
<p>Args: query_int (np.ndarray): Array with query intensities. hits (np.ndarray): Array with reported hits.</p>
<p>Returns: float: Fraction of the matched intensity to the total intensity.</p>
</section>
<section id="file-format" class="level3">
<h3 class="anchored" data-anchor-id="file-format">File Format</h3>
<p>To have an efficient data format to store PSMs in the search. We use <code>numpy</code>-recarrays and define the utility functions <a href="https://mannlabs.github.io/alphapept/search.html#add_column"><code>add_column</code></a> and <a href="https://mannlabs.github.io/alphapept/search.html#remove_column"><code>remove_column</code></a> to append and remove data.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L422" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="remove_column" class="level3">
<h3 class="anchored" data-anchor-id="remove_column">remove_column</h3>
<blockquote class="blockquote">
<pre><code> remove_column (recarray:numpy.ndarray, name:str)</code></pre>
</blockquote>
<p>Function to remove a column from a recarray.</p>
<p>Args: recarray (np.ndarray): NumPy record array. name (str): Column name of the column to be removed.</p>
<p>Returns: np.ndarray: NumPy record array with removed column.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L403" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="add_column" class="level3">
<h3 class="anchored" data-anchor-id="add_column">add_column</h3>
<blockquote class="blockquote">
<pre><code> add_column (recarray:numpy.ndarray, column:numpy.ndarray, name:str)</code></pre>
</blockquote>
<p>Function to add a column with given name to recarray</p>
<p>Args: recarray (np.ndarray): NumPy record array. column (np.ndarray): Data column that should be added to the record array. name (str): Name of the column in the new recordarray.</p>
<p>Returns: np.ndarray: NumPy recordarray with new field.</p>
</section>
</section>
<section id="extracting-features-for-scoring" class="level2">
<h2 class="anchored" data-anchor-id="extracting-features-for-scoring">Extracting features for scoring</h2>
<section id="indices" class="level3">
<h3 class="anchored" data-anchor-id="indices">Indices</h3>
<p>When performing a database search, we need to know which experimental spectrum we compare with what database entry. We distinguish three indices:</p>
<ul>
<li>query_idx</li>
<li>raw_idx</li>
<li>feature_idx</li>
</ul>
<p>Initially, the get_psms function accepts experimental data in the form of <code>query_data</code>. Here, the <code>query_idx</code> refers to the index to <code>query_data</code>. However, this might not be the same index as the raw data. This is due to the implementation of the matching of MS1-features to MS2 spectra. Here we allow multiple matches and implement this by repeating the respective spectrum.</p>
<p>We then add the two columns <code>feature_idx</code> and <code>raw_idx</code> to the PSMs to later be able to distinguish where the match originated. In this case, <code>raw_idx</code> refers to the original spectrum.</p>
<p>When not applying feature finding, <code>raw_idx</code> and <code>query_idx</code> are equivalent.</p>
</section>
<section id="features" class="level3">
<h3 class="anchored" data-anchor-id="features">Features</h3>
<p>In the <a href="https://mannlabs.github.io/alphapept/search.html#score"><code>score</code></a>-function we use the pre-filtered PSMs to extract additional columns for scoring such as the offset from theoretical to experimental precursor or the number of b- and y-ion hits.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L443" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_hits" class="level3">
<h3 class="anchored" data-anchor-id="get_hits">get_hits</h3>
<blockquote class="blockquote">
<pre><code> get_hits (query_frag:numpy.ndarray, query_int:numpy.ndarray,
           db_frag:numpy.ndarray, db_int:numpy.ndarray,
           frag_type:numpy.ndarray, mtol:float, ppm:bool, losses:list)</code></pre>
</blockquote>
<p>Function to extract the types of hits based on a single PSMs.</p>
<p>The reporting array stores information about the matched fragment_ions in a record array.</p>
<p>Args: query_frag (np.ndarray): Array with query fragments. query_int (np.ndarray): Array with query intensities. db_frag (np.ndarray): Array with database fragments. db_int (np.ndarray): Array with database intensities. frag_type (np.ndarray): Array with fragment types. mtol (float): Mass tolerance. ppm (bool): Flag to use ppm instead of Dalton. losses (list): List of losses.</p>
<p>Returns: np.ndarray: NumPy array that stores ion information.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L503" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="score" class="level3">
<h3 class="anchored" data-anchor-id="score">score</h3>
<blockquote class="blockquote">
<pre><code> score (psms:numpy.recarray, query_masses:numpy.ndarray,
        query_masses_raw:numpy.ndarray, query_frags:numpy.ndarray,
        query_ints:numpy.ndarray, query_indices:numpy.ndarray,
        db_masses:numpy.ndarray, db_frags:numpy.ndarray,
        frag_types:numpy.ndarray, mtol:float, db_indices:numpy.ndarray,
        ppm:bool, psms_dtype:list, db_ints:numpy.ndarray=None,
        parallel:bool=False)</code></pre>
</blockquote>
<p>Function to extract score columns when giving a recordarray with PSMs.</p>
<p>Args: psms (np.recarray): Recordarray containing PSMs. query_masses (np.ndarray): Array with query masses. query_masses_raw (np.ndarray): Array with raw query masses. query_frags (np.ndarray): Array with frag types of the query data. query_ints (np.ndarray): Array with fragment intensities from the query. query_indices (np.ndarray): Array with indices to the query data. db_masses (np.ndarray): Array with database masses. db_frags (np.ndarray): Array with fragment masses. frag_types (np.ndarray): Array with fragment types. mtol (float): Mass tolerance. db_indices (np.ndarray): Array with indices to the database array. ppm (bool): Flag to use ppm instead of Dalton. psms_dtype (list): List describing the dtype of the PSMs record array. db_ints (np.ndarray, optional): Array with database intensities. Defaults to None. parallel (bool, optional): Flag to use parallel processing. Defaults to False.</p>
<p>Returns: np.recarray: Recordarray containing PSMs with additional columns. np.ndarray: NumPy array containing ion information.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L613" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_sequences" class="level3">
<h3 class="anchored" data-anchor-id="get_sequences">get_sequences</h3>
<blockquote class="blockquote">
<pre><code> get_sequences (psms:numpy.recarray, db_seqs:numpy.ndarray)</code></pre>
</blockquote>
<p>Get sequences to add them to a recarray</p>
<p>Args: psms (np.recarray): Recordarray containing PSMs. db_seqs (np.ndarray): NumPy array containing sequences.</p>
<p>Returns: np.ndarray: NumPy array containing a subset of sequences.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L631" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="get_score_columns" class="level3">
<h3 class="anchored" data-anchor-id="get_score_columns">get_score_columns</h3>
<blockquote class="blockquote">
<pre><code> get_score_columns (psms:numpy.recarray, query_data:dict,
                    db_data:Union[dict,str],
                    features:pandas.core.frame.DataFrame, parallel:bool,
                    frag_tol:float, prec_tol:float, ppm:bool,
                    prec_tol_calibrated:Union[NoneType,float]=None,
                    frag_tol_calibrated:float=None, **kwargs)</code></pre>
</blockquote>
<p>Wrapper function to extract score columns.</p>
<p>Args: psms (np.recarray): Recordarray containing PSMs. query_data (dict): Data structure containing the query data. db_data: Union[dict, str]: Data structure containing the database data or path to database. features (pd.DataFrame): Pandas dataframe containing feature data. parallel (bool): Flag to use parallel processing. frag_tol (float): Fragment tolerance for search. prec_tol (float): Precursor tolerance for search. ppm (bool): Flag to use ppm instead of Dalton. prec_tol_calibrated (Union[None, float], optional): Calibrated offset mass. Defaults to None. frag_tol_calibrated (float, optional): Fragment tolerance if calibration exists. Defaults to None.</p>
<p>Returns: np.recarray: Recordarray containing PSMs with additional columns. np.ndarray: NumPy array containing ion information.</p>
</section>
</section>
<section id="plot" class="level2">
<h2 class="anchored" data-anchor-id="plot">Plot</h2>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L812" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="plot_psms" class="level3">
<h3 class="anchored" data-anchor-id="plot_psms">plot_psms</h3>
<blockquote class="blockquote">
<pre><code> plot_psms (index, ms_file)</code></pre>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example usage to plot a psms</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>ms_file <span class="op">=</span> alphapept.io.MS_Data_File(<span class="st">'../testfiles/test.ms_data.hdf'</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>plot_psms(<span class="dv">0</span>, ms_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="05_search_files/figure-html/cell-19-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="searching-with-database" class="level2">
<h2 class="anchored" data-anchor-id="searching-with-database">Searching with database</h2>
<p>We save intermediate results to hdf5 files</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L903" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="search_db" class="level3">
<h3 class="anchored" data-anchor-id="search_db">search_db</h3>
<blockquote class="blockquote">
<pre><code> search_db (to_process:tuple, callback:Callable=None, parallel:bool=False,
            first_search:bool=True)</code></pre>
</blockquote>
<p>Wrapper function to perform database search to be used by a parallel pool.</p>
<p>Args: to_process (tuple): Tuple containing an index to the file and the experiment settings. callback (Callable, optional): Callback function to indicate progress. Defaults to None. parallel (bool, optional): Flag to use parallel processing. Defaults to False. first_search (bool, optional): Flag to indicate this is the first search. Defaults to True.</p>
<p>Returns: Union[bool, str]: Returns True if the search was successfull, otherwise returns a string containing the Exception.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L876" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="store_hdf" class="level3">
<h3 class="anchored" data-anchor-id="store_hdf">store_hdf</h3>
<blockquote class="blockquote">
<pre><code> store_hdf (df:pandas.core.frame.DataFrame, path:str, key:str,
            replace:bool=False, swmr:bool=False)</code></pre>
</blockquote>
<p>Wrapper function to store a DataFrame in an hdf.</p>
<p>Args: df (pd.DataFrame): DataFrame to be stored. path (str): Target path of the hdf file. key (str): Name of the field to be saved. replace (bool, optional): Flag whether the field should be replaced.. Defaults to False. swmr (bool, optional): Flag to use swmr(single write multiple read)-mode. Defaults to False.</p>
</section>
</section>
<section id="searching-large-fasta-and-or-search-space" class="level2">
<h2 class="anchored" data-anchor-id="searching-large-fasta-and-or-search-space">Searching Large Fasta and or Search Space</h2>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L994" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="search_fasta_block" class="level3">
<h3 class="anchored" data-anchor-id="search_fasta_block">search_fasta_block</h3>
<blockquote class="blockquote">
<pre><code> search_fasta_block (to_process:tuple)</code></pre>
</blockquote>
<p>Search fasta block. This file digests per block and does not use a saved database. For searches with big fasta files or unspecific searches.</p>
<p>Args: to_process (tuple): Tuple containing a fasta_index, fasta_block, a list of files and a list of experimental settings.</p>
<p>Returns: list: A list of dataframes when searching the respective file. int: Number of new peptides that were generated in this iteration.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L1105" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="filter_top_n" class="level3">
<h3 class="anchored" data-anchor-id="filter_top_n">filter_top_n</h3>
<blockquote class="blockquote">
<pre><code> filter_top_n (temp:pandas.core.frame.DataFrame, top_n:int=10)</code></pre>
</blockquote>
<p>Takes a dataframe and keeps only the top n entries (based on hits). Combines fasta indices for sequences.</p>
<p>Args: temp (pd.DataFrame): Pandas DataFrame containing PSMs. top_n (int, optional): Number of top-n entries to be kept. Defaults to 10.</p>
<p>Returns: pd.DataFrame: Filtered DataFrame.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L1199" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="search_parallel" class="level3">
<h3 class="anchored" data-anchor-id="search_parallel">search_parallel</h3>
<blockquote class="blockquote">
<pre><code> search_parallel (settings:dict, calibration:Union[list,NoneType]=None,
                  fragment_calibration:Union[list,NoneType]=None,
                  callback:Union[Callable,NoneType]=None)</code></pre>
</blockquote>
<p>Function to search multiple ms_data files in parallel. This function will additionally calculate fragments and precursor masses from a given FASTA file.</p>
<p>Args: settings (dict): Settings file containg the experimental definitions. calibration (Union[list, None], optional): List of calibrated offsets. Defaults to None. fragment_calibration (Union[list, None], optional): List of calibrated fragment offsets. Defaults to None. callback (Union[Callable, None], optional): Callback function. Defaults to None.</p>
<p>Returns: dict: FASTA dictionary.</p>
<hr>
<p><a href="https://github.com/mannlabs/alphapept/blob/master/alphapept/search.py#L1143" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="ion_extractor" class="level3">
<h3 class="anchored" data-anchor-id="ion_extractor">ion_extractor</h3>
<blockquote class="blockquote">
<pre><code> ion_extractor (df:pandas.core.frame.DataFrame, ms_file, frag_tol:float,
                ppm:bool)</code></pre>
</blockquote>
<p>Extracts the matched hits (fragment_ions) from a dataframe.</p>
<p>Args: df (pd.DataFrame): Pandas dataframe containing the results of the first search. ms_file : MsFile frag_tol (float): Fragment tolerance for search. ppm (bool): Flag to use ppm instead of Dalton.</p>
<p>Returns: np.ndarray: Numpy recordarray storing the PSMs. np.ndarray: Numpy recordarray storing the fragment_ions.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>